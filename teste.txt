async processarWebhookMercadoPago(body: any) {
    // 1️⃣ Verifica se é evento de pagamento
    const paymentId = body?.data?.id;

    if (!paymentId) {
      return;
    }

    // 2️⃣ Busca pagamento no Mercado Pago
    const pagamento = await this.mercadoPagoService.buscarPagamentoPorId(
      String(paymentId),
    );

    if (!pagamento) return;

    // 3️⃣ Recupera pedido pelo external_reference
    const pedidoId = Number(pagamento.external_reference);

    if (!pedidoId) return;

    const pedido = await this.prisma.pedido.findUnique({
      where: { id: pedidoId },
    });

    if (!pedido) return;

    // 4️⃣ Atualiza status conforme MP
    if (pagamento.status === "approved") {
      await this.prisma.pedido.update({
        where: { id: pedidoId },
        data: {
          status: "PAGO",
          pagamentoId: String(paymentId),
        },
      });
    }

    if (pagamento.status === "rejected") {
      await this.prisma.pedido.update({
        where: { id: pedidoId },
        data: {
          status: "CANCELADO",
        },
      });
    }

    if (pagamento.status === "pending") {
      await this.prisma.pedido.update({
        where: { id: pedidoId },
        data: {
          status: "AGUARDANDO_PAGAMENTO",
        },
      });
    }
  }

  async criarCheckoutMercadoPago(pedidoId: number) {
    const pedido = await this.prisma.pedido.findUnique({
      where: { id: pedidoId },
      include: {
        itens: {
          include: { produto: true },
        },
      },
    });

    if (!pedido) {
      throw new BadRequestException("Pedido não encontrado");
    }

    if (pedido.status !== "PENDENTE") {
      throw new BadRequestException("Pedido inválido");
    }

    await this.prisma.pedido.update({
      where: { id: pedido.id },
      data: { status: "AGUARDANDO_PAGAMENTO" },
    });

    return this.mercadoPagoService.criarCheckoutMercadoPago(pedido);
  }



